name: Auto-Request CodeRabbit Review for Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  request-coderabbit-review:
    # Only run for Dependabot PRs
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Request Safety Confirmation
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const marker = '<!-- coderabbitai-review-request -->';

            // Fetch existing comments with pagination
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Check if we've already commented
            const alreadyCommented = comments.some(comment => comment.body.includes(marker));

            if (alreadyCommented) {
              console.log('Coderabbit comment already exists. Skipping.');
              return;
            }

            // Create the comment if not found
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${marker}\n@coderabbitai Are there any breaking changes in this dependency update? Is it safe to merge?`
            });
